
config:
    name: "Cluster Tgt Test"
    base_url: ${get_cluster_url()}
    parameters:
        host_ip_01-host_ip_02: ${P(umi_cluster/data/glusterfs.csv)}
        req_host-user-passwd-lun_name-lun_size-target_iqn-target_address: ${P(umi_cluster/data/tgt.csv)}
    variables:
        vol_name: vol-01

teststeps:
# -
#     name: Gluster Volume Create Single
#     variables:
#         host01: "${get_host_once(host01)}"
#     testcase: umi_node/glusterfs/module/volume_create_single.yml
-
    name: Tgt Service Status
    request:
        method: POST
        url: "/cluster/iscsi/tgt/service/status"
        json: {
            "req_host": "$req_host"
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Service Init
    request:
        method: POST
        url: "/cluster/iscsi/tgt/service/init"
        json: {
            "req_host": "$req_host"
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Service Enable
    request:
        method: POST
        url: "/cluster/iscsi/tgt/service/enable"
        json: {
            "req_host": "$req_host"
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Lun Info
    request:
        method: POST
        url: "/cluster/iscsi/tgt/lun/info"
        json: {
            "req_host": "$req_host"
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Lun Vfs Update
    request:
        method: POST
        url: "/cluster/iscsi/tgt/lun/vfs_update"
        json: {
            "req_host": "$req_host",
            "path": "/reexport/$vol_name/.iscsi/$lun_name.raw",
            "bstype": "rdwr",
            "lun_size": "$lun_size",
            "thin": true,
            "wcache": true,
            "ex_args": {}
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Lun Glfs Update
    request:
        method: POST
        url: "/cluster/iscsi/tgt/lun/glfs_update"
        json: {
            "req_host": "$req_host",
            "path": "/.iscsi/$lun_name.raw",
            "vol_name": "$vol_name",
            "host": "localhost",
            "lun_size": "$lun_size",
            "thin": true,
            "wcache": true,
            "ex_args": {}
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Lun Status
    request:
        method: POST
        url: "/cluster/iscsi/tgt/lun/status"
        json: {
            "req_host": "$req_host"
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Target Info
    request:
        method: POST
        url: "/cluster/iscsi/tgt/target/info"
        json: {
            "req_host": "$req_host"
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Target Update
    request:
        method: POST
        url: "/cluster/iscsi/tgt/target/update"
        json: {  
            "req_host": "$req_host",
            "iqn": "$target_iqn",
            "acls": [
                "iqn.2005-03.org.open-iscsi:3f5058b1d0a0",
                "iqn.1994‚Äê05.com.redhat:5674d1912c88"
            ],
            "user": "$user",
            "passwd": "$passwd",
            "mutual_user": "$user",
            "mutual_passwd": "$passwd",
            "ex_args": {}
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Target Status
    request:
        method: POST
        url: "/cluster/iscsi/tgt/target/status"
        json: {
            "req_host": "$req_host"
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Target Lun Map Set
    request:
        method: POST
        url: "/cluster/iscsi/tgt/target/lun_map_set"
        json: {
            "req_host": "$req_host",
            "iqn": "$target_iqn",
            "lun_sn_lst": [
              "/reexport/$vol_name/.iscsi/$lun_name.raw",
            ],
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Target Delete
    request:
        method: POST
        url: "/cluster/iscsi/tgt/target/delete"
        json: {
            "req_host": "$req_host",
            "iqn": "$target_iqn"
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Lun Vfs Delete
    request:
        method: POST
        url: "/cluster/iscsi/tgt/lun/vfs_delete"
        json: {
            "req_host": "$req_host",
            "path": "/reexport/$vol_name/.iscsi/$lun_name.raw",
            "clean_data": false
        }
    validate:
        - eq: ["status_code", 200]
-
    name: Tgt Lun Glfs Delete
    request:
        method: POST
        url: "/cluster/iscsi/tgt/lun/glfs_delete"
        json: {
            "req_host": "$req_host",
            "path": "/.iscsi/$lun_name.raw",
            "vol_name": "$vol_name",
            "host": "localhost",
            "clean_data": false
        }
    validate:
        - eq: ["status_code", 200]
# -
#     name: Tgt Config Export
#     request:
#         method: POST
#         url: "/cluster/iscsi/tgt/config/export"
#         json: {
#             "req_host": "$req_host"
#         }
#     validate:
#         - eq: ["status_code", 200]
# -
#     name: Tgt Config Import
#     request:
#         method: POST
#         url: "/cluster/iscsi/tgt/config/import"
#         json: {
#             "req_host": "$req_host",
#             "config": {
#                 "lun": {
#                   "/reexport/$vol_name/.iscsi/$lun_name.raw": {
#                     "wcache": false,
#                     "thin": false,
#                     "lun_size": "2147483648",
#                     "bstype": "aio",
#                     "path": "/reexport/$vol_name/.iscsi/$lun_name.raw"
#                   },
#                   "$vol_name:/.iscsi/lun-02.raw": {
#                     "wcache": true,
#                     "thin": true,
#                     "lun_size": "3221225472",
#                     "host": "localhost",
#                     "vol_name": "$vol_name",
#                     "path": "/.iscsi/lun-02.raw"
#                   }
#                 },
#                 "target": {
#                   "$target_iqn": {
#                     "iqn": "$target_iqn",
#                     "acls": [
#                       "iqn.2005-03.org.open-iscsi:3f5058b1d0a0",
#                       "iqn.1994-05.com.redhat:5674d1912c88"
#                     ],
#                     "user": "$user",
#                     "passwd": "$passwd",
#                     "mutual_user": "$user",
#                     "mutual_passwd": "$passwd"
#                   }
#                 },
#                 "lun_map": {
#                   "$target_iqn": [
#                       "/reexport/$vol_name/.iscsi/$lun_name.raw"
#                   ]
#                 }
#             }
#         }
#     validate:
#         - eq: ["status_code", 200]
-
    name: Tgt Service Disable
    request:
        method: POST
        url: "/cluster/iscsi/tgt/service/disable"
        json: {
            "req_host": "$req_host"
        }
    validate:
        - eq: ["status_code", 200]
# -
#     name: Gluster Volume Delete
#     testcase: umi_node/glusterfs/module/volume_delete.yml
  

